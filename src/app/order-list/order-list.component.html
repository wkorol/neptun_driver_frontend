<div class="orders-container">
    <div class="search-container">
        <mat-form-field appearance="outline">
            <mat-label>Wyszukaj w zleceniach...</mat-label>
            <input
                    matInput
                    [(ngModel)]="searchTerm"
                    (ngModelChange)="updatePanelStates()"
                    placeholder="np. GdaÅ„sk, 501..." />

            <button
                    *ngIf="searchTerm"
                    matSuffix
                    mat-icon-button
                    aria-label="WyczyÅ›Ä‡"
                    (click)="clearSearch()">
                <mat-icon>close</mat-icon>
            </button>
        </mat-form-field>
    </div>


    <!-- ZWIJANE SEKCJE -->
    <mat-accordion multi="true">

        <!-- Sekcja: Aktualne zlecenia -->
        <mat-expansion-panel
            [expanded]="panelOpenState.actual"
            (opened)="setPanelOpen('actual', true)"
            (closed)="setPanelOpen('actual', false)">
            <mat-expansion-panel-header>
                <mat-panel-title>Aktualne zlecenia ({{ actualOrders.length }})</mat-panel-title>
            </mat-expansion-panel-header>

            <div *ngIf="actualOrders.length === 0" class="no-orders">Brak aktywnych zleceÅ„</div>

            <div
                    *ngFor="let order of filteredActualOrders; trackBy: trackByOrderId"
                    class="order-box"
                    [attr.data-order-id]="order.Id"
                    [ngClass]="{
    'airport-order': order.From && (order.From.toLowerCase().includes('lotnisko') || order.From.toLowerCase().includes('juliusza sÅ‚owackiego 200')),
    'non-gdansk-order': order.City && order.City.toLowerCase() !== 'gdaÅ„sk',
    'new-order': isNewOrder(order.Id)
  }"
            >
                <div class="order-header">
                    <h3>{{ order.City || 'Miasto nieznane' }}</h3>
                    <div class="order-header-tags">
                        <span *ngIf="isNewOrder(order.Id)" class="new-badge">NOWE</span>
                        <span class="status">{{ order.Status || 'brak' }}</span>
                    </div>
                </div>
                <div class="order-meta">
                    <span class="created-badge">{{ formatCreatedAt(order.CreatedAt) }}</span>
                </div>
                <div class="order-content">
                    <p><strong>Adres:</strong> {{ order.Street || 'brak' }} {{ order.House || '' }}</p>
                    <p><strong>Z:</strong> {{ order.From }}</p>
                    <p><strong>Do:</strong> {{ order.Destination || 'brak' }}</p>
                    <p><strong>Przyjazd:</strong> {{ formatDate(order.PlannedArrivalDate) }}</p>
                    <p><strong>ğŸ“</strong> {{ order.PhoneNumber || 'brak' }}</p>
                    <p><strong>ğŸš•</strong> {{ order.TaxiNumber || 'brak' }} | ğŸ‘¥ {{ order.PassengersCount || '?' }}</p>
                    <p><strong>Firma:</strong> {{ order.CompanyName || 'brak' }}</p>
                    <p><strong>ğŸ’°</strong> {{ order.Price ? order.Price + ' zÅ‚' : 'brak' }}</p>
                    <p *ngIf="order.Notes"><strong>ğŸ“</strong> {{ order.Notes }}</p>
                    <mat-expansion-panel
                        *ngIf="order._lastOrders"
                        class="history-panel"
                        [expanded]="isHistoryOpen(order.Id)"
                        (opened)="setHistoryOpen(order.Id, true)"
                        (closed)="setHistoryOpen(order.Id, false)">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                ğŸ“ Ostatnie 3 zlecenia dla tego numeru
                            </mat-panel-title>
                        </mat-expansion-panel-header>

                        <div *ngFor="let prev of order._lastOrders; trackBy: trackByOrderId" class="history-item">
                            <p>â¡ï¸ {{ formatDate(prev.PlannedArrivalDate) }}
                                | {{ prev.From }} â†’ {{ prev.Destination }}
                            </p>
                        </div>
                    </mat-expansion-panel>
                    <button mat-stroked-button color="warn" (click)="confirmCancel(order)">
                        Anuluj
                    </button>
                </div>
            </div>
        </mat-expansion-panel>

        <!-- Sekcja: Terminy na dziÅ› -->
        <mat-expansion-panel
            [expanded]="panelOpenState.today"
            (opened)="setPanelOpen('today', true)"
            (closed)="setPanelOpen('today', false)">
            <mat-expansion-panel-header>
                <mat-panel-title>Terminy na dziÅ› ({{ todayOrders.length }})</mat-panel-title>
            </mat-expansion-panel-header>

            <div *ngIf="!isLoading; else loading">
                <div
                        *ngFor="let order of filteredTodayOrders; trackBy: trackByOrderId"
                        class="order-box"
                        [attr.data-order-id]="order.Id"
                    [ngClass]="{
    'airport-order': order.From && (order.From.toLowerCase().includes('lotnisko') || order.From.toLowerCase().includes('juliusza sÅ‚owackiego 200')),
    'non-gdansk-order': order.City && order.City.toLowerCase() !== 'gdaÅ„sk',
    'new-order': isNewOrder(order.Id)
  }"
                >
                    <div class="order-header">
                        <h3>{{ order.City || 'Miasto nieznane' }}</h3>
                    <div class="order-header-tags">
                        <span *ngIf="isNewOrder(order.Id)" class="new-badge">NOWE</span>
                        <span class="status">{{ order.Status || 'brak' }}</span>
                    </div>
                </div>
                <div class="order-meta">
                    <span class="created-badge">{{ formatCreatedAt(order.CreatedAt) }}</span>
                </div>
                <div class="order-content">
                        <p><strong>Adres:</strong> {{ order.Street || 'brak' }} {{ order.House || '' }}</p>
                        <p><strong>Z:</strong> {{ order.From }}</p>
                        <p><strong>Do:</strong> {{ order.Destination || 'brak' }}</p>
                        <p><strong>Przyjazd:</strong> {{ formatDate(order.PlannedArrivalDate) }}</p>
                        <p><strong>ğŸ“</strong> {{ order.PhoneNumber || 'brak' }}</p>
                        <p><strong>ğŸš•</strong> {{ order.TaxiNumber || 'brak' }} | ğŸ‘¥ {{ order.PassengersCount || '?' }}</p>
                        <p><strong>Firma:</strong> {{ order.CompanyName || 'brak' }}</p>
                        <p><strong>ğŸ’°</strong> {{ order.Price ? order.Price + ' zÅ‚' : 'brak' }}</p>
                        <p *ngIf="order.Notes"><strong>ğŸ“</strong> {{ order.Notes }}</p>
                        <mat-expansion-panel
                            *ngIf="order._lastOrders"
                            class="history-panel"
                            [expanded]="isHistoryOpen(order.Id)"
                            (opened)="setHistoryOpen(order.Id, true)"
                            (closed)="setHistoryOpen(order.Id, false)">
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    ğŸ“ Ostatnie 3 zlecenia dla tego numeru
                                </mat-panel-title>
                            </mat-expansion-panel-header>

                            <div *ngFor="let prev of order._lastOrders; trackBy: trackByOrderId" class="history-item">
                                <p>â¡ï¸ {{ formatDate(prev.PlannedArrivalDate) }}
                                    | {{ prev.From }} â†’ {{ prev.Destination }}
                                </p>
                            </div>
                        </mat-expansion-panel>
                        <button mat-stroked-button color="warn" (click)="confirmCancel(order)">
                            Anuluj
                        </button>
                    </div>
                </div>
            </div>
        </mat-expansion-panel>

        <!-- Sekcja: Terminy na kolejne 5 dni -->
        <mat-expansion-panel
            [expanded]="panelOpenState.next5days"
            (opened)="setPanelOpen('next5days', true)"
            (closed)="setPanelOpen('next5days', false)">
            <mat-expansion-panel-header>
                <mat-panel-title>Terminy na nastÄ™pne 5 dni ({{ ordersForNext5Days.length }})</mat-panel-title>
            </mat-expansion-panel-header>

            <div *ngIf="!isLoading; else loading">
                <div
                    *ngFor="let order of filteredOrdersForNext5Days; trackBy: trackByOrderId"
                    class="order-box"
                    [attr.data-order-id]="order.Id"
                    [ngClass]="{
    'airport-order': order.From && (order.From.toLowerCase().includes('lotnisko') || order.From.toLowerCase().includes('juliusza sÅ‚owackiego 200')),
    'non-gdansk-order': order.City && order.City.toLowerCase() !== 'gdaÅ„sk',
    'new-order': isNewOrder(order.Id)
  }"
            >
                    <div class="order-header">
                        <h3>{{ order.City || 'Miasto nieznane' }}</h3>
                    <div class="order-header-tags">
                        <span *ngIf="isNewOrder(order.Id)" class="new-badge">NOWE</span>
                        <span class="status">{{ order.Status || 'brak' }}</span>
                    </div>
                </div>
                <div class="order-meta">
                    <span class="created-badge">{{ formatCreatedAt(order.CreatedAt) }}</span>
                </div>
                <div class="order-content">
                        <p><strong>Adres:</strong> {{ order.Street || 'brak' }} {{ order.House || '' }}</p>
                        <p><strong>Z:</strong> {{ order.From }}</p>
                        <p><strong>Do:</strong> {{ order.Destination || 'brak' }}</p>
                        <p><strong>Przyjazd:</strong> {{ formatDate(order.PlannedArrivalDate) }}</p>
                        <p><strong>ğŸ“</strong> {{ order.PhoneNumber || 'brak' }}</p>
                        <p><strong>ğŸš•</strong> {{ order.TaxiNumber || 'brak' }} | ğŸ‘¥ {{ order.PassengersCount || '?' }}</p>
                        <p><strong>Firma:</strong> {{ order.CompanyName || 'brak' }}</p>
                        <p><strong>ğŸ’°</strong> {{ order.Price ? order.Price + ' zÅ‚' : 'brak' }}</p>
                        <p *ngIf="order.Notes"><strong>ğŸ“</strong> {{ order.Notes }}</p>
                        <mat-expansion-panel
                            *ngIf="order._lastOrders"
                            class="history-panel"
                            [expanded]="isHistoryOpen(order.Id)"
                            (opened)="setHistoryOpen(order.Id, true)"
                            (closed)="setHistoryOpen(order.Id, false)">
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    ğŸ“ Ostatnie 3 zlecenia dla tego numeru
                                </mat-panel-title>
                            </mat-expansion-panel-header>

                            <div *ngFor="let prev of order._lastOrders; trackBy: trackByOrderId" class="history-item">
                                <p>â¡ï¸ {{ formatDate(prev.PlannedArrivalDate) }}
                                    | {{ prev.From }} â†’ {{ prev.Destination }}
                                </p>
                            </div>
                        </mat-expansion-panel>
                        <button mat-stroked-button color="warn" (click)="confirmCancel(order)">
                            Anuluj
                        </button>
                    </div>
                </div>
            </div>
        </mat-expansion-panel>

    </mat-accordion>

    <mat-expansion-panel class="history-orders-panel">
        <mat-expansion-panel-header>
            <mat-panel-title>Historia zleceÅ„ z dnia</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="history-container">
            <div class="history-header">
                <h2>Wybierz dzieÅ„</h2>
                <div class="history-controls">
                    <mat-form-field appearance="outline" class="history-date">
                        <mat-label>Data</mat-label>
                        <input
                            matInput
                            type="date"
                            [(ngModel)]="historyDate"
                            (ngModelChange)="onHistoryDateChange()" />
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="history-size">
                        <mat-label>Na stronie</mat-label>
                        <mat-select
                            [(ngModel)]="historyPageSize"
                            (selectionChange)="onHistoryPageSizeChange()">
                            <mat-option *ngFor="let size of historyPageSizeOptions" [value]="size">
                                {{ size }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>

            <div class="history-pagination" *ngIf="historyTotal > historyPageSize">
                <button
                    mat-stroked-button
                    (click)="goToHistoryPage(historyPage - 1)"
                    [disabled]="historyPage <= 1">
                    Poprzednia
                </button>
                <span>Strona {{ historyPage }} / {{ historyTotalPages }}</span>
                <button
                    mat-stroked-button
                    (click)="goToHistoryPage(historyPage + 1)"
                    [disabled]="historyPage >= historyTotalPages">
                    NastÄ™pna
                </button>
            </div>

            <div *ngIf="historyLoading" class="history-loading">
                <mat-spinner diameter="32"></mat-spinner>
                <span>Åadowanie historii...</span>
            </div>

            <div *ngIf="!historyLoading && historyOrders.length === 0" class="no-orders">
                Brak zleceÅ„ dla wybranego dnia
            </div>

            <div *ngIf="!historyLoading">
                <div
                    *ngFor="let order of historyOrders; trackBy: trackByOrderId"
                    class="order-box"
                    [attr.data-order-id]="order.Id"
                    [ngClass]="{
        'airport-order': order.From && (order.From.toLowerCase().includes('lotnisko') || order.From.toLowerCase().includes('juliusza sÅ‚owackiego 200')),
        'non-gdansk-order': order.City && order.City.toLowerCase() !== 'gdaÅ„sk'
      }"
                >
                    <div class="order-header">
                        <h3>{{ order.City || 'Miasto nieznane' }}</h3>
                        <div class="order-header-tags">
                            <span class="status">{{ order.Status || 'brak' }}</span>
                        </div>
                    </div>
                    <div class="order-meta">
                        <span class="created-badge">{{ formatCreatedAt(order.CreatedAt) }}</span>
                    </div>
                    <div class="order-content">
                        <p><strong>Adres:</strong> {{ order.Street || 'brak' }} {{ order.House || '' }}</p>
                        <p><strong>Z:</strong> {{ order.From }}</p>
                        <p><strong>Do:</strong> {{ order.Destination || 'brak' }}</p>
                        <p><strong>Przyjazd:</strong> {{ formatDate(order.PlannedArrivalDate) }}</p>
                        <p><strong>ğŸ“</strong> {{ order.PhoneNumber || 'brak' }}</p>
                        <p><strong>ğŸš•</strong> {{ order.TaxiNumber || 'brak' }} | ğŸ‘¥ {{ order.PassengersCount || '?' }}</p>
                        <p><strong>Firma:</strong> {{ order.CompanyName || 'brak' }}</p>
                        <p><strong>ğŸ’°</strong> {{ order.Price ? order.Price + ' zÅ‚' : 'brak' }}</p>
                        <p *ngIf="order.Notes"><strong>ğŸ“</strong> {{ order.Notes }}</p>
                    </div>
                </div>
            </div>
        </div>
    </mat-expansion-panel>

    <ng-template #loading>
        <p>Åadowanie zamÃ³wieÅ„...</p>
    </ng-template>

</div>
